# 计算机网络

## 带宽的单位是 bps（bit/s），流量的单位是 Bps（Byte/s）

## TCP/IP 五层模型

- 应用层 —— 报文：HTTP、DNS、FTP、SMTP、SSH
- 运输层 —— 报文段（segment）：TCP、UDP
- 网络层 —— 数据报（data-gram）：IP、ICMP
- 数据链路层 —— 数据帧：Ethernet、802.11
- 物理层：

此外，还有 OSI 7 层模型，相比上述的 5 层模型，在应用层与运输层之间加了**表示层**和**会话层**。

## IP

IP 即**网际协议**，它为主机之间提供了逻辑通信。
IP 的服务模型是**尽力而为交付服务**（best-effort delivery service）。
这意味着 IP 尽它“最大的努力”在通信的主机之间交付报文段，但它并不做任何确保。
特别是，它不确保报文段的交付，不保证报文段的按序交付，不保证报文段中数据的完整性。
由于这些原因，IP 被称为**不可靠服务（unreliable service）**。

## UDP 和 TCP

UDP 和 TCP 最基本的责任是，将两个端系统间 IP 的交付服务扩展为运行在端系统上的两个进程之间的交付服务。
将主机间交付扩展到进程间交付被称为**运输层的多路复用**（transport-layer multiplexing）与**多路分解**（demultiplexing）。

UDP 和 TCP 还可以通过在其报文段首部中包括差错检查字段而提供完整性检查。
进程到进程的数据交付和差错检查是两种最低限度的运输层服务，也是 UDP 所能提供的仅有的两种服务。
特别是，与 IP 一样，UDP 也是一种不可靠的服务，即不能保证一个进程所发送的数据能够完整无缺地（或全部！）到达目的进程。

另一方面，TCP 为应用程序提供了几种附加服务：

- **可靠数据传输**（reliable data transfer）
- **拥塞控制**（congestion control）

## 多路复用与多路分解

一个进程（作为网络应用的一部分）有一个或多个**套接字**（socket），它相当于从网络向进程传递数据和从进程向网络传递数据的门户。

将运输层报文段中的数据交付到正确的套接字的工作称为**多路分解**（demultiplexing）。
在源主机从不同套接字中收集数据块，并为每个数据块封装上首部信息（这将在以后用于分解）从而生成报文段，然后将报文段传递到网络层，所有这些工作称为**多路复用**（multiplexing）。

运输层多路复用要求：

1. 套接字有唯一标识符；
2. 每个报文段有特殊字段来指示该报文段所要交付到的套接字。

如下图所示：

![源与目的端口字段](../images/src-dest-port-fields.jpg)

这些特殊字段是**源端口号字段**（source port number field）和**目的端口号字段**（destination port number field）。

一个 UDP 套接字是由一个二元组全面标识的，该二元组包含一个目的 IP 地址和一个目的端口号。

TCP 套接字和 UDP 套接字之间的一个细微差别是，TCP 套接字是由一个四元组（源 IP 地址，源端口号、目的 IP 地址、目的端口号）来标识的。

事实上，当今的高性能 Web 服务器通常只使用一个进程，但是为每个新的客户连接创建一个具有新连接套接字的新线程。

运输层最低限度必须提供一种复用/分解服务，以便在网络层与正确的应用级进程之间传递数据。

## 从输入 URL 到展现页面的全过程

1. 客户的操作系统生成一个 **DHCP 请求报文**，并将这个报文放入具有目的端口 67（DHCP 服务器）和源端口 68（DHCP 客户）的 **UDP 报文段**，该 UDP 报文段则被放置在一个具有广播 IP 目的地址（255.255.255.255）和源 IP 地址 0.0.0.0 的 **IP 数据报**中，因为此时客户还没有一个 IP 地址。
2. 包含 DHCP 请求报文的 IP 数据报则被放置在**以太网帧**中。该以太网帧具有目的 MAC 地址 FF:FF:FF:FF:FF:FF，使该帧将广播到与交换机连接的所有设备（如果顺利的话也包括 DHCP 服务器）；该帧的源 MAC 地址是客户的 MAC 地址（如：00:16:D3:23:68:8A）。
3. 包含 DHCP 请求的广播以太网帧是第一个由客户发送到以太网交换机的帧。该交换机在所有的出端口广播入帧，包括连接到路由器的端口。
4. 路由器在它的具有 MAC 地址 00:22:6B:45:1F 的接口接收到该广播以太网帧，该帧中包含 DHCP 请求，并且从该以太网帧中抽取出 IP 数据报。该数据报的广播 IP 目的地址指示了这个 IP 数据报应当由在该节点的高层协议处理，因此该数据报的载荷（一个 UDP 报文段）**被分解**向上到达 UDP，DHCP 请求报文从此 UDP 报文段中抽取出来。此时 DHCP 服务器有了 DHCP 请求报文。
5. DHCP 服务器生成 IP 地址以及 DNS 服务器的 IP 地址、默认网关路由器的 IP 地址和子网块（等价为“网络掩码”）的一个 **DHCP ACK 报文**。该 DHCP 报文被放入一个 UDP 报文段中，UDP 报文段被放入一个 IP 数据报中，IP 数据报再被放入一个以太网帧中。这个以太网帧的源 MAC 地址是路由器连到归属网络时接口的 MAC 地址（00:22:6B:45:1F:1B），目的 MAC 地址是客户的 MAC 地址（00:16:D3:23:68:8A）。
6. 包含 DHCP ACK 的以太网帧由路由器发送给交换机。因为交换机是**自学习**的，并且先前从客户收到（包含 DHCP 请求）以太网帧，所以该交换机知道寻址到 00:16:D3:23:68:8A 的帧仅从通向客户的输出端口转发。
7. 客户接收到包含 DHCP ACK 的以太网帧，从该以太网帧中抽取 IP 数据报，从 IP 数据报中抽取 UDP 报文段，从 UDP 报文段抽取 DHCP ACK 报文。客户的 DHCP 客户则记录下它的 IP 地址和它的 DNS 服务器的 IP 地址。它还在其 **IP 转发表**中安装默认网关的地址。客户将向该默认网关发送目的地址为其子网以外的所有数据报。此时，客户已经初始化好它的网络组件，并准备开始处理 Web 网页获取。
8. 客户的操作系统因此生成一个 **DNS 查询报文**，将字符串 www.google.com 放入 DNS 报文的问题段中。该 DNS 报文则放置在一个具有 53 号（DNS 服务器）目的端口的 UDP 报文段中。该 UDP 报文段则被放入 IP 数据报中。
